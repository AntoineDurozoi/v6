var FbFileUpload={initialize:function(e,t){var i=this;this.setPlugin("emundus_fileupload"),this.parent(e,t),this.container=jQuery(this.container),this.toppath=this.options.dir,"1"===this.options.folderSelect&&!0===this.options.editable&&this.ajaxFolder(),this.doBrowseEvent=null,this.watchBrowseButton(),this.options.ajax_upload&&!1!==this.options.editable&&(Fabrik.fireEvent("fabrik.fileupload.plupload.build.start",this),this.watchAjax(),0!==Object.keys(this.options.files).length&&(this.uploader.trigger("FilesAdded",this.options.files),jQuery.each(this.options.files,function(e,t){var a={filepath:t.path,uri:t.url,showWidget:!1},o=jQuery(Fabrik.jLayouts["fabrik-progress-bar-success"])[0],n=jQuery("#"+t.id).find(".bar")[0];i.uploader.trigger("UploadProgress",t),i.uploader.trigger("FileUploaded",t,{response:JSON.stringify(a)}),jQuery(n).replaceWith(o)})),this.redraw()),this.doDeleteEvent=null,this.watchDeleteButton(),this.hideButtonDelete(),this.watchTab()},redraw:function(){var e=jQuery(this.element);if(this.options.ajax_upload){var t=jQuery("#"+e.prop("id")+"_browseButton"),i=jQuery("#"+this.options.element+"_container"),a=t.position().left-i.position().left,o=i.closest(".fabrikElement").find("input[type=file]");if(o.length>0){var n=o.parent();n.css({width:t.width(),height:t.height()}),n.css("top",a)}}},doBrowse:function(e){if(window.File&&window.FileReader&&window.FileList&&window.Blob){var t,i=this,a=e.target.files[0];if(a.type.match("image.*"))(t=new FileReader).onload=function(e){return function(e){var t=jQuery(i.getContainer()),a=t.find("img");a.attr("src",e.target.result),a.closest(".fabrikHide").removeClass("fabrikHide"),t.find("[data-file]").addClass("fabrikHide")}}.bind(this)(a),t.readAsDataURL(a);else if(a.type.match("video.*")){var o,n=jQuery(this.getContainer()),r=n.find("video");if(r.length>0&&(r=this.makeVideoPreview()).appendTo(n),t=new window.FileReader,(t=window.URL||window.webKitURL)&&t.createObjectURL)return o=t.createObjectURL(a),void r.attr("src",o);if(!window.FileReader)return void console.log("Sorry, not so much");(t=new window.FileReader).onload=function(e){r.attr("src",e.target.result)},t.readAsDataURL(a)}}},watchBrowseButton:function(){var e=jQuery(this.element);this.options.useWIP&&!this.options.ajax_upload&&!1!==this.options.editable&&(e.off("change",this.doBrowseEvent),this.doBrowseEvent=this.doBrowse.bind(this),e.on("change",this.doBrowseEvent))},hideButtonDelete:function(){var e=document.getElementsByClassName("em-deleteFile");console.log(e),e.style.display="none"},doDelete:function(e){e.preventDefault();var t=jQuery(this.getContainer()),i=this,a=t.find("[data-file]");if(console.log(t),window.confirm(Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_CONFIRM_SOFT_DELETE"))){var o=a.data("join-pk-val");new jQuery.ajax({url:"",data:{option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"fileupload",method:"ajax_clearFileReference",element_id:this.options.id,formid:this.form.id,rowid:this.form.options.rowid,joinPkVal:o}}).done(function(){Fabrik.trigger("fabrik.fileupload.clearfileref.complete",i)}),window.confirm(Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_CONFIRM_HARD_DELETE"))&&(this.makeDeletedImageField(this.groupid,a.data("file")).appendTo(t),Fabrik.fireEvent("fabrik.fileupload.delete.complete",this)),a.remove(),jQuery(this.element).closest(".fabrikElement").find("img").attr("src",""!==this.options.defaultImage?Fabrik.liveSite+this.options.defaultImage:"")}},watchDeleteButton:function(){var e=jQuery(this.getContainer()).find("[data-file]");e.off("click",this.doDeleteEvent),this.doDeleteEvent=this.doDelete.bind(this),e.on("click",this.doDeleteEvent)},getFormElementsKey:function(e){return this.baseElementId=e,this.options.ajax_upload&&this.options.ajax_max>1?this.options.listName+"___"+this.options.elementShortName:this.parent(e)},removeCustomEvents:function(){},cloned:function(e){var t=jQuery(this.element);0!==t.closest(".fabrikElement").length&&(t.closest(".fabrikElement").find("img").attr("src",""!==this.options.defaultImage?Fabrik.liveSite+this.options.defaultImage:""),jQuery(this.getContainer()).find("[data-file]").remove(),this.watchBrowseButton(),this.parent(e))},decloned:function(e){jQuery("#form_"+this.form.id).find("input[name=fabrik_deletedimages["+e+"]]").length>0&&this.makeDeletedImageField(e,this.options.value).inject(this.form.form)},decreaseName:function(e){var t=this.getOrigField();return"null"!==typeOf(t)&&(t.name=this._decreaseName(t.name,e),t.id=this._decreaseId(t.id,e)),this.parent(e)},getOrigField:function(){var e=this.element.getParent(".fabrikElement"),t=e.getElement("input[name^="+this.origId+"_orig]");return"null"===typeOf(t)&&(t=e.getElement("input[id^="+this.origId+"_orig]")),t},makeDeletedImageField:function(e,t){return jQuery(document.createElement("input")).attr({type:"hidden",name:"fabrik_fileupload_deletedfile["+e+"][]",value:t})},makeVideoPreview:function(){var e=jQuery(this.element);return jQuery(document.createElement("video")).attr({id:e.prop("id")+"_video_preview",controls:!0})},update:function(e){if(this.element){var t=jQuery(this.element);if(""===e)this.options.ajax_upload?(this.uploader.files=[],t.parent().find("[id$=_dropList] tr").remove()):t.val("");else{var i=t.closest("div.fabrikSubElementContainer").find("img");i&&i.prop("src",e)}}},addDropArea:function(){if(Fabrik.bootstraped){var e,t=this.container.find("tr.plupload_droptext");t.length>0?t.show():(e=jQuery(document.createElementget("tr")).addClass("plupload_droptext").html('<td colspan="4"><i class="icon-move"></i> '+Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_DRAG_FILES_HERE")+" </td>"),this.container.find("tbody").append(e)),this.container.find("thead").hide()}},removeDropArea:function(){this.container.find("tr.plupload_droptext").hide()},watchAjax:function(){if(!1!==this.options.editable){var e=this,t=jQuery(this.element).prop("id"),i=jQuery(this.getElement());if(0!==i.length){var a=i.closest(".fabrikSubElementContainer");this.container=a,!1!==this.options.canvasSupport&&(this.widget=new ImageWidget(this.options.modalId,{imagedim:{x:200,y:200,w:this.options.winWidth,h:this.options.winHeight},cropdim:{w:this.options.cropwidth,h:this.options.cropheight,x:this.options.winWidth/2,y:this.options.winHeight/2},crop:this.options.crop,modalId:this.options.modalId,quality:this.options.quality})),this.pluploadContainer=a.find(".plupload_container"),this.pluploadFallback=a.find(".plupload_fallback"),this.droplist=a.find(".plupload_filelist");var o="index.php?option=com_fabrik&format=raw&task=plugin.pluginAjax";o+="&plugin=fileupload&"+this.options.ajaxToken+"=1",o+="&method=ajax_upload&element_id="+this.options.elid,this.options.isAdmin&&(o="administrator/"+o);var n={runtimes:this.options.ajax_runtime,browse_button:t+"_browseButton",container:t+"_container",drop_element:t+"_dropList_container",url:o,max_file_size:this.options.max_file_size+"kb",unique_names:!1,flash_swf_url:this.options.ajax_flash_path,silverlight_xap_url:this.options.ajax_silverlight_path,chunk_size:this.options.ajax_chunk_size+"kb",dragdrop:!0,multipart:!0,filters:this.options.filters,page_url:this.options.page_url};this.uploader=new plupload.Uploader(n),this.uploader.bind("Init",function(t,i){e.pluploadFallback.remove(),e.pluploadContainer.removeClass("fabrikHide"),t.features.dragdrop&&t.settings.dragdrop&&e.addDropArea()}),this.uploader.bind("FilesRemoved",function(e,t){}),this.uploader.bind("FilesAdded",function(t,i){e.removeDropArea();var a,o=Fabrik.bootstrapped?"tr":"li";e.lastAddedFiles=i,Fabrik.bootstrapped&&e.container.find("thead").css("display",""),a=e.droplist.find(o).length,jQuery.each(i,function(t,i){var n,r,s;i.size>1e3*e.options.max_file_size?window.alert(Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_FILE_TOO_LARGE_SHORT")):a>=e.options.ajax_max?window.alert(Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_MAX_UPLOAD_REACHED")):(a++,e.isImage(i)?(n=e.editImgButton(),e.options.crop?n.html(e.options.resizeButton):n.html(e.options.previewButton),r=jQuery(document.createElement("span")).text(i.name)):(n=jQuery(document.createElement("span")),r=jQuery(document.createElement("a")).attr({href:i.url,target:"_blank"}).text(i.name)),s=e.imageCells(i,r,n),e.droplist.append(jQuery(document.createElement(o)).attr({id:i.id,class:"plupload_delete"}).append(s)))}),setTimeout(function(){t.start()},100)}),this.uploader.bind("UploadProgress",function(e,t){var i=jQuery("#"+t.id);if(i.length>0)if(Fabrik.bootstrapped){var a=i.find(".plupload_file_status .bar");if(a.css("width",t.percent+"%"),100===t.percent){var o=jQuery(Fabrik.jLayouts["fabrik-progress-bar-success"]);a.replaceWith(o)}}else i.find(".plupload_file_status").text(t.percent+"%")}),this.uploader.bind("Error",function(t,i){e.lastAddedFiles.each(function(t){var a=jQuery("#"+t.id);a.length>0&&(a.remove(),window.alert(i.message)),e.addDropArea()})}),this.uploader.bind("ChunkUploaded",function(e,t,i){"object"==typeof(i=JSON.parse(i.response))&&i.error&&fconsole(i.error.message)}),this.uploader.bind("FileUploaded",function(t,i,a){var o,n,r,s,l=jQuery("#"+i.id);if((a=JSON.parse(a.response)).error)return window.alert(a.error),void l.remove();0!==l.length?((r=l.find(".plupload_resize a")).show(),r.attr({href:a.uri,id:"resizebutton_"+i.id}),r.data("filepath",a.filepath),e.widget&&(n=!1!==a.showWidget,e.widget.setImage(a.uri,a.filepath,i.params,n)),o=e.options.inRepeatGroup?e.options.elementName.replace(/\[\d*\]/,"["+e.getRepeatNum()+"]"):e.options.elementName,jQuery(document.createElement("input")).attr({type:"hidden",name:o+"[crop]["+a.filepath+"]",id:"coords_"+i.id,value:JSON.stringify(i.params)}).insertAfter(e.pluploadContainer),jQuery(document.createElement("input")).attr({type:"hidden",name:o+"[cropdata]["+a.filepath+"]",id:"data_"+i.id}).insertAfter(e.pluploadContainer),s=[i.recordid,"0"].pick(),jQuery(document.createElement("input")).attr({type:"hidden",name:o+"[id]["+a.filepath+"]",id:"id_"+i.id,value:s}).insertAfter(e.pluploadContainer),l.removeClass("plupload_file_action").addClass("plupload_done"),e.isSubmitDone()):fconsole("Filuploaded didnt find: "+i.id)}),this.uploader.init()}}},imageCells:function(e,t,i){var a,o,n,r=this.deleteImgButton();return Fabrik.bootstrapped?(n=jQuery(document.createElement("td")).addClass(this.options.spanNames[1]+" plupload_resize").append(i),o=Fabrik.jLayouts["fabrik-progress-bar"],a=jQuery(document.createElement("td")).addClass(this.options.spanNames[5]+" plupload_file_status").html(o),[jQuery(document.createElement("td")).addClass(this.options.spanNames[6]+" plupload_file_name").append(t),n,a,r]):[new Element("div",{class:"plupload_file_name"}).adopt([t,new Element("div",{class:"plupload_resize",style:"display:none"}).adopt(i)]),r,a=new Element("div",{class:"plupload_file_status"}).set("text","0%"),new Element("div",{class:"plupload_file_size"}).set("text",e.size),new Element("div",{class:"plupload_clearer"})]},editImgButton:function(){var e=this;return Fabrik.bootstrapped?jQuery(document.createElement("a")).addClass("editImage").attr({href:"#",alt:Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_RESIZE")}).css({display:"none"}).on("click",function(t){t.preventDefault(),e.pluploadResize(jQuery(this))}):new Element("a",{href:"#",alt:Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_RESIZE"),events:{click:function(e){e.stop();var t=e.target.getParent();this.pluploadResize(jQuery(t))}.bind(this)}})},deleteImgButton:function(){if(Fabrik.bootstrapped){var e=Fabrik.jLayouts["fabrik-icon-delete"],t=this;return jQuery(document.createElement("td")).addClass(this.options.spanNames[1]+" plupload_file_action").append(jQuery(document.createElement("a")).html(e).attr({href:"#"}).on("click",function(e){e.stopPropagation(),t.pluploadRemoveFile(e)}))}return new Element("div",{class:"plupload_file_action"}).adopt(new Element("a",{href:"#",style:"display:block",events:{click:function(e){this.pluploadRemoveFile(e)}.bind(this)}}))},isImage:function(e){if(void 0!==e.type)return"image"===e.type;var t=e.name.split(".").pop().toLowerCase();return["jpg","jpeg","png","gif"].contains(t)},pluploadRemoveFile:function(e){if(e.stopPropagation(),window.confirm(Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_CONFIRM_HARD_DELETE"))){var t=jQuery(e.target).closest("tr").prop("id").split("_").pop(),i=jQuery(e.target).closest("tr").find(".plupload_file_name").text(),a=[];this.uploader.files.each(function(e){e.id!==t&&a.push(e)}),this.uploader.files=a;var o=this,n={option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"fileupload",method:"ajax_deleteFile",element_id:this.options.id,file:i,recordid:t,repeatCounter:this.options.repeatCounter};n[this.options.ajaxToken]=1,jQuery.ajax({url:"",data:n}).done(function(i){""===(i=JSON.parse(i)).error&&(Fabrik.trigger("fabrik.fileupload.delete.complete",o),jQuery(e.target).closest(".plupload_delete").remove(),jQuery("#id_alreadyuploaded_"+o.options.id+"_"+t).remove(),jQuery("#coords_alreadyuploaded_"+o.options.id+"_"+t).remove(),0===jQuery(o.getContainer()).find("table tbody tr.plupload_delete").length&&o.addDropArea())})}},pluploadResize:function(e){this.widget&&this.widget.setImage(e.attr("href"),e.data("filepath"),{},!0)},isSubmitDone:function(){this.allUploaded()&&"function"==typeof this.submitCallBack&&(this.saveWidgetState(),this.submitCallBack(!0),delete this.submitCallBack)},onsubmit:function(e){this.submitCallBack=e,this.allUploaded()?(this.saveWidgetState(),this.parent(e)):this.uploader.start()},saveWidgetState:function(){void 0!==this.widget&&jQuery.each(this.widget.images,function(e,t){e=e.split("\\").pop();var i=jQuery('input[name*="'+e+'"]').filter(function(e,t){return t.name.contains("[crop]")});if((i=i.last()).length>0){var a=t.img;delete t.img,i.val(JSON.stringify(t)),t.img=a}})},allUploaded:function(){var e=!0;return this.uploader&&this.uploader.files.each(function(t){0===t.loaded&&(e=!1)}),e}};console.log(FbFileUpload);